# 捕鱼核心


## 对象的分析
基于面向对象的分析原则，一个捕鱼游戏必定会有以下对象
```
场景 控制 普通场景和潮汐鱼阵场景的 循环切换
子弹 用于捕获鱼
炮台 用于发射子弹，可切换不同的炮台、倍率
鱼   单条鱼
鱼群 有规则的一组鱼
```

## 鱼和鱼群



## 子弹
** 子弹类 Bullet **
```
int32 m_id; // 子弹实例化id 
int32 m_ratio; //子弹分数  
int32 m_type; //子弹类型即道具id
uint32 m_multiple; //奖励倍数
```
其中 m_ratio 是在 客户端发射子弹时传递的炮灰倍率，之后不会发生改变（比如玩家更改了倍率），

**子弹管理类 BulletMgr**

**子弹的射击**
交互协议 
```
//玩家子弹
message CSUserShoot   
{
	required int32 angle = 1; 				//发射角度                                
	required int32 bullet_id = 2;			//这颗子弹的id
	required int32 ratio = 3;				//子弹倍率
	required int32 bullet_type = 4;			//子弹类型(300~500分别指电钻炮,电磁炮,普通,精良,稀有,史诗电钻电磁炮,普通炮)
}
// 通知客户端玩家多发子弹
message SCUserShoot
{
	required int32 chair_idx = 1;    		//玩家坐位号
	required int32 angle = 2;				//子弹信息	
	required int64 score = 3;				//玩家当前分数
	required int32 bullet_type = 4;			//子弹类型
}
```
子弹的id(bullet_id)是客户端生成的，生成的规则是 int类型 从0自增，超过10000，就重置为0，不同玩家的子弹id是可以相同的，但是子弹对象是包括子弹id和所属玩家座位号的，所以子弹id相同而作为号不相同的子弹是不会冲突的。

子弹倍率(ratio)是这客户端在发射子弹时炮台的倍率，子弹创建成功后，这个值是不会发生变化的。


注意:
参数好像没做封包校验 m_ratio  m_type m_id
子弹发生失败的情况下，也同步给了别人 SCUserShoot

## 炮台
在代码中 Gun 类，一个炮台必备的属性有
```
炮台角度(x,y)
发射的子弹id
大炮的等级
炮灰倍率
锁定倍率

等等其它
```

**设置炮灰倍率**


**炮台的同步**
```
//客户请求炮火倍率
message CSSetProbability 
{
	optional int32 add_or_del = 1;    		//增减分数						
	optional int32 gun_level = 2;        	//大炮二次分级倍率
	optional bool is_use_auto = 3;			//是否使用自动倍率
}
//客户端收到炮火倍率
message SCSetProbability 
{
	required int32 code = 1;				//返回错误码(0:表示成功)
	optional int32 chair_idx = 2;       	//玩家桌子号						
	optional int32 gun_ratio = 3;      		//玩家炮火值 						
	optional int32 gun_level = 4;       	//大炮二次分级倍率 
	optional string msg = 5;				//错误提示信息	
}
```

##
1.鱼的创建
2.子弹的发射与销毁
3.子弹攻击
4.鱼的消耗


## 场景的管理
这个游戏有两个场景，普通场景和潮汐场景，游戏会在两个阶段轮询执行，每个阶段都有固定配置时长.




## 鱼的创建与销毁
游戏的鱼创建鱼销毁的管理是 FishMgr 类，它管理 单条鱼 Fish 和 鱼群 FishGroup。

Fish 类，包括的属性有 鱼的种类、鱼的阶段(0:普通场景 1:潮汐场景)、是否是一网打尽标志. 

Fish 类中包含 阶段 stage 的主要作用是 计算鱼分值时，成长鱼限定了阶段

FishGoup 类

FishMgr 类
```


makeFishTracesDataToClient 将待刷新的鱼同步给桌子玩家

```

## 鱼的捕获

## 子弹的管理


## 炮台


## 鱼相关配置

**服务器 FishType跟配置文件硬编码**
```
//闪电海鳗
#define	FISH_TYPE_EEL		132
//穿云蟹
#define	FISH_TYPE_ROCKET	133
//电磁蟹
#define	FISH_TYPE_LASER		134
//黄金巨龙
#define	FISH_TYPE_DRAGON	136
//闪电蝴蝶
#define	FISH_TYPE_BUTTERFLY	139
//闪电蜻蜓
#define	FISH_TYPE_DRAGONFLY	140
//奇遇蟹
#define	FISH_TYPE_FREE_GUN	141
//转盘鱼
#define	FISH_TYPE_WHEEL		142
//一网打尽
#define	FISH_TYPE_ACED		143	
```

**按鱼的外形分类**
```
//1按鱼的外形分类
enum FishShapeType
{
	FishShapeTypeLittle = 0,  // 小鱼
	FishShapeTypeBig = 1, // 大鱼
};
```

**鱼功能类型**
```
enum FishFuncType
{
	//普通鱼
	FishFuncTypeNormal = 0,
	//掉落鱼
	FishFuncTypeDrop = 1,
	//升级鱼
	FishFuncTypeUpgrade = 2,
	//闪电鱼
	FishFuncTypeShock = 3,
	//奖金鱼
	FishFuncTypeAward = 4,
	//转盘鱼
	FishFuncTypeWheel = 5,

	FishFuncTypeMax,
};
```


**道具**






## 火箭炮

--------
## 特殊鱼

## 特殊鱼-召唤鱼
原需求文档 https://www.tapd.cn/60204148/prong/stories/view/1160204148001020546

**需求总结**
```
1.获得召唤道具 
    击杀奖金鱼概率掉落召唤道具，客户端实时显示召唤道具数量
2.使用召唤道具,服务校验通过后生成鱼
```

**协议**
```
召唤道具掉落协议
//特殊鱼捕获结算
message SCHitSpecialFish
{
	required int32 chair_idx = 1;    		//玩家坐位号
	required int32 fish_uid = 2;         	//产鱼编号
	required int32 earn = 3;				//单条鱼捕获收益
	required int32 fish_value = 4;			//鱼分值
	required int64 user_score = 5;			//玩家当前分数
	required bool death = 6;				//鱼死亡(只掉落道具时鱼不死)
	optional int32 grow_stage = 7;			//成长阶段(河豚)
	optional int32 multiple = 8;			//奖励倍数
	repeated Object shock_fishes = 9;		//相关联的鱼列表
	repeated Object drop_props = 10;		//掉落道具
	optional WheelObject wheel = 11;		//转盘鱼
}

请求召唤鱼 消息号 Req_CallFish
message CSCallFish
{	
}
message SCCallFish
{
	required int32 chair_idx = 1;		//玩家坐位号
	required int32 propId = 2;			//道具id
	required int32 remain = 3;			//道具剩余数量
	required int32 code = 4;			//返回错误码(0:表示成功)
	optional string msg = 5;			//错误提示信息
}
```

**数据**
```
PartIdCall 10
Call.h Call.cpp

存储数据格式json：{{}，"partId":{"v1":0,"v2":0}}
注：v1是剩余道具数量; v2是最新获得道具的时间
```

**配置**
```
CallFishConf.h CallFishConf.cpp
```

**测试**
```
1.如何快速获得召唤卡
2.如何直接修改玩家数据召唤卡
3.新老数据兼容，以前玩家数据中已有召唤卡数量，要清理掉

```
--------

## 特殊鱼-穿云蟹
穿云蟹是一种特殊鱼，通过 击杀后不掉落金币，只掉落`穿云火箭`,穿云火箭是一种会反弹的穿透弹，通过穿云火箭命中的鱼获得金币收益。


[需求文档](https://www.tapd.cn/60204148/prong/stories/view/1160204148001016595?url_cache_key=7bd304b65d5653521cce5bc5bcf8fbea&action_entry_type=story_tree_list) 

** 穿云蟹配置 **
excel表配置

在 fish 标签页，新增 穿云蟹
```
ID 133
Name 穿云蟹
Type 0
FuncType 1
Score 225
RandScore null
```
在 fish_ctrl 标签页
```
在 DropProp 中新增 {"FishType":123,"PropId":300,"Count":{"left":150,"right":301}
在 ScreenControl 中 添加同屏控制 1
```

在 create_fish_list 标签页中添加创建规则
```
{
						-- ["FishType"] = {133}, 
						-- ["FishRoad"] = {"TS05","TS06","TS07","TS08","PX01","PX02"},
						-- ["Ratio"] = 3,
						-- ["Base"] = 100,
					-- },
```

在 create_fish_process 标签页 普通场景 中包含创建规则。


**穿云蟹的捕获处理** 

针对穿云蟹的捕获 在CSHitFish请求，参数screen_fishes需要填充客户端全屏幕的鱼，

message CSHitFish  
{
	required int32 fish_uid = 1;         	//产鱼编号					
	required int32 bullet_id = 2;			//子弹id
	repeated int32 screen_fishes = 3;       //屏幕内所有鱼的编号(有相关联鱼时才发)
}

根据子弹类型 确定 捕获处理器

--------
