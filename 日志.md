# 日志
---

日志的目标
- 记录数据
- 记录行为
- 记录服务器异常

## 游戏中的数据
### 玩家基本数据

### 玩家附加数据
玩家附加数据是以json格式存储在 game_qp_H5srbydld.db.MKeyValue 数据库表中。 

玩家在db存储的数据示例如下:
```
{
	"1": "{\"v1\":100,\"v2\":10,\"v3\":1000,\"v4\":10000}",
	"2": "{\"v1\":0,\"v2\":0}",
	"3": "{\"v1\":0,\"v2\":0,\"v3\":1582298145}",
	"5": "{\"v1\":9,\"v10\":0,\"v11\":1,\"v12\":1973,\"v13\":10000,\"v2\":20,\"v3\":28,\"v4\":1,\"v5\":10,\"v6\":0,\"v7\":0,\"v8\":0,\"v9\":0}",
	"6": "{\"v1\":0,\"v2\":0,\"v3\":9,\"v4\":0}",
	"7": "{\"v1\":-1503940,\"v2\":-20912717,\"v3\":20191231}",
	"8": "{\"v1\":0,\"v2\":0}",
	"9": "{\"v1\":0,\"v2\":0,\"v3\":10,\"v4\":2}",
	"10": "{\"v1\":3,\"v2\":1589191394}",
	"11": "{\"v1\":0,\"v2\":0}"
}
```

数据语义描述

| id | 名称                                        | 子项说明                                                    |
|----|-------------------------------------------|---------------------------------------------------------|
| 1  | 玩家炮台\(普通\)                                | v1~v4分别是初级~专家场炮台倍数                                      |
| 2  | 公共奖池玩家重复领奖控制，未使用                          | v1:中奖金额、v2:中奖时间                                         |
| 3  | v1:新手暗送池\(送出值\)、v2:充值暗送池\(剩余值\)、v3:新手暗送时间 | v1:新手暗送池\(送出值\)、v2:充值暗送池\(剩余值\)、v3:新手暗送时间               |
| 4  | 未使用                                       |                                                         |
| 5  | 暗送刮刮卡                                     | v1~v10分别是每种卡数量， v11:cardType，v12:基数 ,v13:倍数             |
| 6  | vip信息                                     | v1~v3分别是会员炮台标记、vip炮台标记、勋章最近一次vip等级                      |
| 7  | 亏损值                                       | v1:暗送刮刮卡\(累计玩家亏损C值,掉卡重置\)、v2:玩家总亏损值\(奖池C值\)  v3:重置C值批次号 |
| 8  | 个人奖池                                      | v1:当前奖池累积值， v2:玩家开关状态                                   |
| 9  | 鱼雷                                        | v1~v4分别是青铜、白银、黄金、铂金弹头;                                  |
| 10 | 召唤                                        | v1是剩余道具数量;v2是最新获得道具的时间                                  |

如何修改数据：
- 直接去数据库修改
- 使用QPSQLTool修改

玩家附加数据 进出、变更的记录可以在 player_extra_***.log 日志中找到。


## 游戏日志

## 玩家基本数据

### 玩家附加数据日志
日志文件 player_extra_*.log

示例:
```
Login_2020-05-13 16:54:12,{"1":"{\"v1\":10,\"v2\":10,\"v3\":1000,\"v4\":10000}","10":"{\"v1\":135,\"v2\":1589287685}","2":"{\"v1\":0,\"v2\":0}","3":"{\"v1\":0,\"v2\":0,\"v3\":1582298145}","5":"{\"v1\":1,\"v10\":0,\"v11\":0,\"v12\":0,\"v13\":0,\"v2\":0,\"v3\":0,\"v4\":0,\"v5\":0,\"v6\":0,\"v7\":0,\"v8\":0,\"v9\":0}","6":"{\"v1\":0,\"v2\":0,\"v3\":9,\"v4\":0}","7":"{\"v1\":31757970,\"v2\":78768933,\"v3\":20191231}","9":"{\"v1\":0,\"v2\":0,\"v3\":1,\"v4\":0}"},prop_center:{}
leave_2020-05-13 16:55:03,{"1":"{\"v1\":10,\"v2\":10,\"v3\":1000,\"v4\":10000}","10":"{\"v1\":135,\"v2\":1589287685}","2":"{\"v1\":0,\"v2\":0}","3":"{\"v1\":0,\"v2\":0,\"v3\":1582298145}","5":"{\"v1\":0,\"v10\":0,\"v11\":0,\"v12\":0,\"v13\":0,\"v2\":0,\"v3\":0,\"v4\":0,\"v5\":0,\"v6\":0,\"v7\":0,\"v8\":0,\"v9\":0}","6":"{\"v1\":0,\"v2\":0,\"v3\":9,\"v4\":0}","7":"{\"v1\":34554470,\"v2\":81565433,\"v3\":20191231}","9":"{\"v1\":0,\"v2\":0,\"v3\":0,\"v4\":0}"},prop_center:{}
455666_trace:
propId:602, cost:1000000, earn:1016500, 2020-05-13 16:54:46
```
其中trace是 鱼雷的记录



### 玩家大金额金币日志
日志文件 player_big_earn_*.log

大额收益最低记录值配置在 game_conf.lua ["BigMoneyMin"] = 1 * 1000

示例如下:
```text
{"game":10087,"arena":2,"server":1,"playerId":150107,"nickname":"QP_P150107E5E61871","sysId":1,"sysName":"捕捉普通鱼","earn":6000,"remark":500,"time":"2020-05-13 21:58:29"}
```
sysId定义见 全局金币日志 sysId 类型定义


### 写入db的游戏行为日志
数据库提供了一些表，可以用于写入游戏日志，对应的存储过程为 SY_GameCenter.dbo.PrPs_Common_User_Log_Add ,这个过程根据日志类型写入日志到不同的表。

其中H5捕鱼使用的 LogType 定义及对应的表关系:
```
	//刮刮卡统计日志
	DBCommonLogTypeGivenCard int32 = 2 [SY_GameCenterLog].[GameLog].[UserScratchCardLog]
	//四人捕鱼个人奖池抽奖记录
	DBCommonLogTypeUserPoolDraw int32 = 14  [SY_GameCenterLog].[GameLog].[UserPoolAwardLog]
	//捕鱼进退个人奖池日志
	DBCommonLogTypeUserPoolInOut int32 = 15  [SY_GameCenterLog].[GameLog].[UserEnterGamePoolLog]
```

游戏服往db写日志是通过 world服务 OnCommonUserLogAdd grpc接口的，我们可以在 info.log 日志里搜索 OnCommonUserLogAdd 可以看到所有上报的日志请求及请求参数.


请求的数据格式如下:
```
GameID:10087 ArenaID:4 LogType:2 Data:"具体的record"
```
其中 LogType 就是上面的日志类型，H5捕鱼共使用了 2、14、15 三种。

Data 代表具体的记录

写db时间间隔 game_conf.lua FlushDBSec ["FlushDBSec"] = 120

#### 刮刮卡 LogType:2

Data格式: ArenaID, DBID, 卡类型，卡预期价值，卡价值，卡最终面值，基数，倍数，状态，vip等级，时间，当前触发用户量

示例:
```
Data:"4,455666,1,50000000,12977000,50000000,1366,9500,2,9,2020-05-13 16:54:54,0"
```
其中的状态 1:表示掉落刮刮卡 2:表示使用刮刮卡


#### 个人奖池抽奖 LogType:14
Data格式：ArenaID, DBID, 当前奖池金币，抽奖后奖池金币，抽奖ID，消耗，抽奖道具，道具数量，时间

示例:
```	 
Data:"2,150107,914084843,909084843,6,5000000,100,1500000,2020-05-13 21:02:33;2,150107,909084843,904084843,6,5000000,100,7500000,2020-05-13 21:04:16"
```

#### 捕鱼进退个人奖池日志 LogType:15
Data格式：ArenaID, DBID, 进入游戏奖池金币，退出游戏奖池金币，进入时间，退出时间，记录时间

示例:
```	 
Data:"4,455666,0,0,2020-05-13 16:54:12,2020-05-13 16:55:03,2020-05-13 16:55:03" 
```

### 玩家详情日志
日志文件 player_detail_*.log

示例:
```
{
 "玩家ID": 455666,
 "初始金币": 10000000,
 "金币消耗": 1780000,
 "金币获得": 14983500,
 "金币峰值": 23403500,
 "金币峰值时间": "2020-05-13 16:54:55",
 "最大赢分": "",
 "初始价值": 26000000,
 "价值消耗": 52780000,
 "价值获得": 14983500,
 "价值峰值": 26020000,
 "价值峰值时间": "2020-05-13 16:54:17",
 "money快照": [
  "login,money:10000000,value:26000000,time:2020-05-13 16:54:12",
  "leave,money:23203500,value:23203500,time:2020-05-13 16:55:03"
 ]
}
2020/05/13 16:55:03.479200 Info E:/work/qp/h5by/internal/logger/user_log_mgr.go:222: 
455666_Money_Detail:
ratio:10000
sysId:1, cost:1780000.000000, earn:990000.000000
sysId:0, cost:1780000.000000, earn:990000.000000
ratio:0
sysId:302, cost:1000000.000000, earn:1016500.000000
sysId:300, cost:51000000.000000, earn:13993500.000000
sysId:303, cost:50000000.000000, earn:12977000.000000

455666_Money_Sum:
sysId:1, cost:1780000.000000, earn:990000.000000
sysId:0, cost:1780000.000000, earn:990000.000000
sysId:302, cost:1000000.000000, earn:1016500.000000
sysId:300, cost:51000000.000000, earn:13993500.000000
sysId:303, cost:50000000.000000, earn:12977000.000000
2020/05/13 16:55:03.480200 Info E:/work/qp/h5by/internal/logger/user_log_mgr.go:226: 
455666_Monster:
id:105, cost:60000.000000, earn:90000.000000, costM:60000, earnM:90000, hit:6, capture:1, taxVal:0.000000, givenVal:0.000000, percent:1.500000
id:110, cost:90000.000000, earn:0.000000, costM:90000, earnM:0, hit:9, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:109, cost:420000.000000, earn:0.000000, costM:420000, earnM:0, hit:42, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:104, cost:70000.000000, earn:0.000000, costM:70000, earnM:0, hit:7, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:114, cost:10000.000000, earn:0.000000, costM:10000, earnM:0, hit:1, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:107, cost:660000.000000, earn:900000.000000, costM:660000, earnM:900000, hit:66, capture:6, taxVal:0.000000, givenVal:0.000000, percent:1.363636
id:112, cost:440000.000000, earn:0.000000, costM:440000, earnM:0, hit:44, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:117, cost:30000.000000, earn:0.000000, costM:30000, earnM:0, hit:3, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
TotalCost:1780000.000000, TotalEarn:990000.000000, TotalCostMoney:1780000, TotalEarnMoney:990000
```
从上面的示例可以看出日志分三块 Money(玩家货币汇总)、Money_Detail(玩家货币系统详情)、Monster(打怪详情)


### 全局打怪日志
游戏服定时5分钟会打印打怪日志到 global_monster_*.log

定时配置在 game_conf.lua ["FishCacheTimeSec"] = 300

格式:
```text
id:鱼类型id, cost:玩家支出, earn:玩家收益, costM:金币支出, earnM:金币收益, hit:击中次数, capture:捕获次数, taxVal:扣税价值, givenVal:暗送价值.
TotalCost:总玩家支出, TotalEarn:总玩家收益, TotalCostMoney:总金币支出, TotalEarnMoney:总金币收益
```

示例如下:
```
total:
id:107, cost:660000.000000, earn:900000.000000, costM:660000, earnM:900000, hit:66, capture:6, taxVal:0.000000, givenVal:0.000000, percent:1.363636
id:112, cost:440000.000000, earn:0.000000, costM:440000, earnM:0, hit:44, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:117, cost:30000.000000, earn:0.000000, costM:30000, earnM:0, hit:3, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:105, cost:60000.000000, earn:90000.000000, costM:60000, earnM:90000, hit:6, capture:1, taxVal:0.000000, givenVal:0.000000, percent:1.500000
id:110, cost:90000.000000, earn:0.000000, costM:90000, earnM:0, hit:9, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:109, cost:420000.000000, earn:0.000000, costM:420000, earnM:0, hit:42, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:104, cost:70000.000000, earn:0.000000, costM:70000, earnM:0, hit:7, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
id:114, cost:10000.000000, earn:0.000000, costM:10000, earnM:0, hit:1, capture:0, taxVal:0.000000, givenVal:0.000000, percent:0.000000
TotalCost:1780000.000000, TotalEarn:990000.000000, TotalCostMoney:1780000, TotalEarnMoney:990000
```

### 全局金币日志
游戏服定时5分钟会打印打怪日志到 global_money_*.log

定时配置在 game_conf.lua ["FishCacheTimeSec"] = 300

示例如下:
```
Detail:
ratio:10000
sysId:1, cost:16620000.000000, earn:12860000.000000
sysId:0, cost:16620000.000000, earn:12860000.000000
sysId:13, cost:0.000000, earn:750000.000000
ratio:0
sysId:301, cost:5000000.000000, earn:1500000.000000
sysId:300, cost:5000000.000000, earn:1500000.000000

Summary:
sysId:1, cost:16620000.000000, earn:12860000.000000
sysId:0, cost:16620000.000000, earn:12860000.000000
sysId:13, cost:0.000000, earn:750000.000000
sysId:301, cost:5000000.000000, earn:1500000.000000
sysId:300, cost:5000000.000000, earn:1500000.000000
```

sysId 类型定义如下:
```
	//打鱼类
	MoneyCatchFish int32 = 0
	//捕捉普通鱼
	MoneyNormalFish int32 = 1
	//捕捉穿云蟹
	MoneyCatchRocket int32 = 2
	//穿云火箭使用
	MoneyUseRocket int32 = 3
	//捕捉电磁蟹
	MoneyCatchLaser int32 = 4
	//电磁炮使用
	MoneyUseLaser int32 = 5
	//捕捉奇遇蟹
	MoneyCatchFreeGun int32 = 6
	//无限大炮打鱼
	MoneyFreeGunFish int32 = 7
	//无限大炮加时间
	MoneyFreeGunTime int32 = 8
	//无限大炮加倍数
	MoneyFreeGunMulti int32 = 9
	//转盘鱼收支
	MoneyWheelFish int32 = 10
	//一网打尽收支
	MoneyAcedFish int32 = 11
	//闪电鱼
	MoneyShockFish int32 = 12
	//个人奖池积累
	MoneyUserPoolSum int32 = 13
	//捕捉雷皇龙
	// MoneyRayDragon int32 = 14
	//使用龙珠
	// MoneyUseDragonBall int32 = 15

	//赠送类
	MoneyGiven int32 = 100
	//微信新用户赠送
	MoneyWeChatGiven int32 = 101
	//充值暗送
	MoneyChargeGiven int32 = 102
	//刮刮卡赠送
	MoneyCardGiven int32 = 103

	//奖励类
	MoneyAward int32 = 200
	//奖池A中奖金币
	MoneyAwardPoolA int32 = 201
	//奖池B中奖金币
	MoneyAwardPoolB int32 = 202

	//道具类
	MoneyProp int32 = 300
	//个人奖池抽奖
	MoneyUserPoolDraw int32 = 301
	//火箭炮使用
	MoneyUseTorpedo int32 = 302
	//刮刮卡金币
	MoneyUseCard int32 = 303

	MoneyInvalid int32 = 9999
```

### 大奖奖池日志
日志文件 award_pool_*.log

示例:
```
{"level":"info","ts":"2020-05-13T16:53:54.526+0800","msg":"{\"gameId\":10087,\"arenaId\":4,\"type\":1,\"pools\":{\"0\":308600,\"1\":462900,\"2\":771500,\"3\":0,\"4\":0},\"remark\":\"refresh\"}"}
{"level":"info","ts":"2020-05-13T16:53:54.541+0800","msg":"{\"gameId\":10087,\"arenaId\":4,\"type\":2,\"pools\":{\"0\":0,\"1\":0,\"2\":0},\"remark\":\"save\"}"}
```

### 防刷池日志
游戏服会定时5分钟更新防刷池增量到db，通过请求world服务 OnUpdatePreventCheat 接口。

写入db的过程是 SY_GameCenter.PrPs_BaseGoldPool_Update ，具体在 SY_GameCenter.GameInfo.BaseGoldPool 表中

可以在 info.log 日志里查询防刷池更新请求，搜索关键字 OnUpdatePreventCheat ，参数 goldNUM 的值就是累计的增量。

游戏也为防刷池专门生成了一个 prevent_cheat_*.log ，打印示例如下:
```text
{"level":"info","ts":"2020-05-13T17:48:42.711+0800","msg":"init","防刷池初始值":4994860000,"caller":"E:/work/qp/h5by/internal/global/prevent_cheat.go 40"}
{"level":"info","ts":"2020-05-13T17:49:18.724+0800","msg":"update","初始值":4994860000,"增加":1560000,"减少":0,"差值":1560000,"总差值":1560000,"caller":"E:/work/qp/h5by/internal/global/prevent_cheat.go 91"}
{"level":"info","ts":"2020-05-13T17:50:32.861+0800","msg":"update","初始值":4996420000,"增加":1840000,"减少":1500000,"差值":340000,"总差值":1900000,"caller":"E:/work/qp/h5by/internal/global/prevent_cheat.go 91"}
{"level":"info","ts":"2020-05-13T17:51:02.897+0800","msg":"update","初始值":4996760000,"增加":1340000,"减少":30000,"差值":1310000,"总差值":3210000,"caller":"E:/work/qp/h5by/internal/global/prevent_cheat.go 91"}
{"level":"info","ts":"2020-05-13T17:51:32.915+0800","msg":"update","初始值":4998070000,"增加":1180000,"减少":1600000,"差值":-420000,"总差值":2790000,"caller":"E:/work/qp/h5by/internal/global/prevent_cheat.go 91"}
```
启动服务器时会打印 防刷池初始值 这一行，之后就会定时5分钟打印一次，其中 差值 就是阶段时间内累计的增量，会写往db，写成功后游戏服会清理缓存,而 总差值 是开服以来累计的增量，不会清理，它代表了该游戏服从开服以来实际总的输赢。

防刷池有一个当前防刷池值小于最低限制就自动关服的机制，最低配置值在 game_conf.lua ["PreventCheatMin"] = 50000 * 10000, 如果自动关服会在 error.log 日志里打印如下错误
```text
Prevent Cheat Pool Too Low
```



## 日志中心
日志中心地址 http://log.huoys.com/app/kibana#/home 用户名:h5-user 密码：huoys.com

游戏日志目前仅预发布和线上会上报，才能在上面查。

## 小结


## 统计